name: Backend CI

on:
  push:
  pull_request:

jobs:
  test-backend:
    runs-on: ubuntu-latest

    env:
      NODE_ENV: test
      DB_DIALECT: sqlite
      DB_STORAGE: ":memory:"
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      JWT_EXPIRES_IN: "1d"
      SMTP_HOST: smtp.gmail.com
      SMTP_PORT: 587
      SMTP_USER: ${{ secrets.SMTP_USER }}
      SMTP_PASS: ${{ secrets.SMTP_PASS }}
      EMAIL_FROM: Beasy
      RESET_DB: true

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: |
          npm install

      - name: Run backend tests with coverage
        run: |
          npm run coverage

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage

      - name: Start backend
        run: |
          npm install
          npm run start &  
          sleep 5           

      - name: Run k6 tests in Docker
        run: |
          docker run --rm -v ${{ github.workspace }}/k6:/scripts loadimpact/k6 run /scripts/load_login.js
          docker run --rm -v ${{ github.workspace }}/k6:/scripts loadimpact/k6 run /scripts/spike_login.js
          docker run --rm -v ${{ github.workspace }}/k6:/scripts loadimpact/k6 run /scripts/load_professional_me.js
          docker run --rm -v ${{ github.workspace }}/k6:/scripts loadimpact/k6 run /scripts/spike_professional_me.js


      - name: Deploy to Render
        if: success()
        run: |
          curl -X POST "https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID }}/deploys" \
          -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
          -H "Content-Type: application/json" \
          -d '{}' 